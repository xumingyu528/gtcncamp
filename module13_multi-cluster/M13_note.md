[toc]


# 集群

可以将多地域的节点组成同一集群，通过 Annotation 标记不同地域及可用区，应用发布时有倾向的调度到对应区域，或者根据用户调度到不同地域的 Service


# 集群联邦
* 单一集群的管理规模有上限
* 数据库存储
  * etcd 作为 Kubernetes 集群的后端存储数据库，对空间大小的要求比较苛刻，限制了集群能存储的对象数量和大小
* 内存占用
  * API Server 作为网关，会对集群所有对象进行缓存。集群越大，缓存需要的内存就越大
  * 控制器也需要对侦听的对象构建客户端缓存，需要占用系统内存
* 控制器复杂度
  * 随着集群对象数量增长，控制器处理耗时也会越来越长
* 单个计算节点资源上限
  * 单个节点除了 CPU、内存等可量化的资源
* 故障域控制
* 应用高可用部署
* 混合云


## 联邦对象
* Template：定义 Kubernetes 对象的模板
* Placement：定义联邦对象需要被同步的目标集群
* Overrides：不同目标集群中，对 Kubernetes 对象模板的本地化属性




# 多集群治理方案：Clusternet

* karmada：华为主导的k8s多集群管理的项目，全称是 Kubernetes Armada
* Clusternet：腾讯主导的

## Clusternet 能力一览
* 统一管控各类 Kubernetes 集群
* 集群管理 Pull/Push 模式
* 轻量化，开箱即用，易于部署和维护
* 跨集群的服务发现和服务互访
* Kubernetes 原生，没有额外的学习成本
* 完善的 RBAC 能力，访问任一子集群
* 完善的接入能力：kubectl plugin / client-go
* 支持分发各类原生应用 / CRD / HelmChart

## 多集群管理的挑战
* 集群无处不在
* 公有云、私有云、混合云、边缘、裸金属
* 提供一致的纳管能力
  * 集群一键注册能力
  * 一致性的集群访问体验，比如 exec，logs
  * 权限管控 RBAC
* 架构要足够轻量化，方便一键接入

## Clusternet 架构

### 通过 Clusternet 访问任一自己群
* Clusternet 支持通过 Bootstrap Token，Service Token，TLS证书等 RBAC 的方式访问子集群
  * 子集群的 credential 信息不需要存放在父集群中
* 也支持通过 kubectl 命令行的方式对子集群进行 create/get/list/watch/patch/exec 等操作





# 基于 Istio 的多集群治理
## 跨地域流量管理的挑战
* 采用多活数据中心的网络拓扑，任何生产应用都需要完成跨三个数据中心的部署
* 为满足单集群的高可用，针对每个数据中心，任何应用都需要进行多副本部署，并配置负载均衡
* 以实现全站微服务化，但为保证高可用，服务之间的调用仍以南北流量为主
* 针对核心应用，除集群本地负载均衡配置以外，还需配置跨数据中心负载均衡，并通过权重控制将99% 的请求转入本地数据中心，将1% 的流量转向跨地域的数据中心。

## 规模化带来的挑战
以eBay为例：3 主数据中心，20 边缘数据中心，100+ Kubernetes 集群  
### 规模化运营 Kubernetes 集群
* 总计 100000 物理节点
* 单机群物理机节点规模高达 5000

### 业务服务全面容器化，单集群  
* Pod 示例可达 100000
* 发布服务 5000 - 10000
  
### 单集群多环境支持  
* 功能测试、集成测试、压力测试公用单集群
* 不同环境需要彼此隔离

### 异构应用  
* 云业务，大数据，搜索服务
* 多种应用协议
* 灰度发布

### 日益增长的安全需求  
* 全链路TLS


### 可见性需求
* 访问日志
* Tracing





## 多集群部署
### Kubernetes 集群联邦
* 集群联邦 API Server 作为用户访问 Kubernetes 集群入口
* 所有 Kubernetes 集群注册至集群联邦

### 可用区
* 数据中心具有独立供电制冷设备的故障域
* 同一可用区有较小忘记罗延迟
* 同一可用区部署了多个 Kubernetes 集群

### 多集群部署
* 同一可用区设定一个网关集群
* 网关集群中部署 Istio Primary
* 同一可用区的其它集群中部署 Istio Remote
* 所有集群采用相同 RootCA
* 相同环境 TrustDomain 相同


### 东西南北流量统一管控
* 同一可用区的服务调用基于 Sidecar
* 跨可用区的服务调用基于 Istio Gateway




## 入站流量架构 L4 + L7
为不同应用配置独立的网关服务以方便网络隔离。  
基于 IPVS/xDP 的 Service Controller：  
* 四层网关调度
* 虚拟 IP 地址分配
* 基于 IPIP 协议的转发规则配置
* 基于 BGP 的 IP 路由宣告
* 在 Ingress Pod 中配置 Tunnel 设备，并绑定虚拟 IP 地址以卸载 IPIP 包

## 单网关集群多环境支持




## 应用高可用接入方案


## 为应用发布服务




## 为 workload 添加 locality 信息



## 应对规模化集群挑战




## Istiod 自身的规模控制




## 统一流量模型：NameService




